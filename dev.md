# Blender MCP 云端连接开发文档

## 项目目标

实现本地 Blender 到云端 Blender MCP 服务再到本地 Blender 的连接使用流程，同时确保不同 Blender 实例之间的隔离。

## 当前架构

当前的 Blender MCP 系统由以下主要组件组成：

1. **Blender 插件 (addon.py)**：
   - 在本地 Blender 中运行的插件
   - 创建一个 Socket 服务器（默认在 localhost:9876）
   - 接收并执行来自 MCP 服务器的命令

2. **MCP 服务器 (server.py)**：
   - 实现 Model Context Protocol (MCP)
   - 连接到本地 Blender 插件的 Socket 服务器
   - 作为 Claude AI 与 Blender 之间的桥梁

3. **连接流程**：
   - 本地 Blender 插件启动 Socket 服务器
   - MCP 服务器连接到该 Socket 服务器
   - Claude AI 通过 MCP 服务器向 Blender 发送命令

## 开发计划

为了实现云端连接和实例隔离，我们将进行以下修改：

### 1. 修改 server.py

- 支持远程连接和多客户端连接
- 实现用户认证和会话管理
- 添加实例标识和隔离机制
- 实现跨实例通信的路由功能
- 添加安全层（如 SSL/TLS）

### 2. 修改 addon.py

- 添加远程连接选项，允许用户指定是连接本地服务还是云端服务
- 添加认证功能，如 API 密钥或用户名/密码
- 实现实例标识和注册机制
- 修改现有的 socket 通信代码，使其支持远程连接

## 实现细节

### 用户和会话隔离

- 每个用户有唯一的 API 密钥和用户 ID
- 每个用户可以有多个 Blender 实例
- 不同用户的 Blender 实例完全隔离

### 实例标识和隔离

- 每个连接的 Blender 实例都有唯一标识
- 同一用户的不同 Blender 实例默认隔离
- 只有通过显式的路由命令才能实现跨实例通信

### 安全考虑

- 使用 API 密钥进行用户认证
- 使用 SSL/TLS 加密所有通信
- 实现命令白名单，限制可执行的命令范围
- 记录所有操作以便审计

## 实现步骤

1. 添加用户认证和会话管理
2. 实现实例注册和标识
3. 修改通信代码支持远程连接
4. 实现跨实例通信路由
5. 添加安全层和加密
6. 测试和优化

## 云连接功能

### 概述

实现了一个安全的云连接系统，用于连接多个本地 Blender 实例到云端服务器。该系统确保了不同用户之间的 Blender 实例的隔离，使得每个用户只能访问和控制自己的 Blender 实例。

### 主要特性

1. **用户认证与会话管理**
   - 用户 ID 和 API 密钥机制
   - 会话超时和自动清理
   - 实例注册和管理

2. **安全通信**
   - SSL/TLS 加密连接
   - API 密钥验证
   - 实例隔离策略

3. **实例管理**
   - 每个用户可以注册和管理多个 Blender 实例
   - 远程命令路由
   - 实例状态监控

### 实现细节

#### 服务器端

1. **UserSession 类**
   - 存储用户会话信息，包括用户 ID、API 密钥和活跃的 Blender 连接
   - 提供会话活动更新和超时管理

2. **用户认证和实例注册**
   - `validate_api_key`: 验证 API 密钥并返回对应的用户 ID
   - `create_user`: 创建新用户并生成 API 密钥
   - `register_blender_instance`: 注册新的 Blender 实例
   - `list_blender_instances`: 列出用户的所有 Blender 实例

3. **连接管理**
   - 修改了 `BlenderConnection` 类，添加了用户 ID 和实例 ID
   - 更新了 `get_blender_connection` 函数，支持通过用户 ID 和实例 ID 获取连接
   - 添加了远程连接支持，包括 SSL/TLS 加密

4. **命令路由**
   - `route_command`: 将命令路由到指定的 Blender 实例

5. **安全性**
   - 自动生成自签名证书（开发环境）
   - 严格的用户认证和实例隔离
   - 会话超时和清理

#### 客户端（Blender 插件）

1. **远程模式**
   - 添加了远程模式支持，允许连接到远程服务器
   - 用户可配置 API 密钥、远程主机和端口

2. **SSL/TLS 加密**
   - 支持加密连接，确保数据传输安全
   - 适当的错误处理和回退机制

3. **认证和注册**
   - 实现了实例注册和认证流程
   - 存储和管理实例 ID

### 使用方法

#### 服务器端

1. **启动服务器**
   ```bash
   python -m blender_mcp.server --host 0.0.0.0 --port 5000 --allow-remote
   ```

   参数说明：
   - `--host`: 服务器监听地址，使用 `0.0.0.0` 允许所有网络接口访问
   - `--port`: 服务器端口
   - `--debug`: 启用调试模式
   - `--allow-remote`: 允许远程连接
   - `--ssl-cert`: SSL 证书路径（可选）
   - `--ssl-key`: SSL 密钥路径（可选）
   - `--admin-key`: 管理员 API 密钥（可选，如果未指定将自动生成）

2. **用户和实例管理 API**
   - 创建用户: `POST /api/create_user?username=<用户名>`
   - 注册实例: `POST /api/register_blender_instance?api_key=<API密钥>&instance_name=<实例名称>`
   - 列出实例: `GET /api/list_blender_instances?api_key=<API密钥>`
   - 命令路由: `POST /api/route_command?api_key=<API密钥>&target_instance_id=<目标实例ID>&command_type=<命令类型>`

#### Blender 插件

1. **配置远程连接**
   - 在 Blender 中，进入 BlenderMCP 面板
   - 启用"远程模式"选项
   - 填写远程服务器信息：主机、端口和 API 密钥
   - 点击"启动服务器"按钮（在远程模式下，这会连接到远程服务器并注册实例）

2. **排错**
   - 检查 Blender 控制台输出以获取连接和认证信息
   - 确保服务器允许远程连接并正确配置了 SSL
   - 验证 API 密钥是否有效

### 安全注意事项

1. **生产环境部署**
   - 使用适当的 SSL 证书（不是自签名）
   - 设置防火墙规则，只允许必要的连接
   - 定期轮换 API 密钥
   - 监控服务器日志以检测潜在的安全问题

2. **用户隔离**
   - 每个用户只能访问自己的 Blender 实例
   - 实例间命令和数据不共享
   - 会话超时确保资源释放和安全

3. **数据安全**
   - 所有通信均经过 SSL/TLS 加密
   - API 密钥不应公开共享
   - 敏感数据不应存储在远程服务器上

### 开发注意事项

1. **扩展功能**
   - 添加用户权限管理
   - 实现实例共享和协作功能
   - 增强监控和日志记录

2. **性能优化**
   - 命令批处理
   - 连接池管理
   - 大型数据传输优化

3. **错误处理**
   - 改进连接失败重试机制
   - 增强错误和异常处理
   - 实现自动重连功能
